package com.quizapp.servlet;
import com.quizapp.dao.AttemptDAO;
import com.quizapp.dao.QuizDAO;
import com.quizapp.model.Question;
import com.quizapp.model.User;

import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;
import javax.servlet.*;
import java.io.IOException;
import java.util.List;

@WebServlet("/quiz/submit")
public class SubmitQuizServlet extends HttpServlet {
    private QuizDAO qdao = new QuizDAO();
    private AttemptDAO adao = new AttemptDAO();

    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        int quizId = Integer.parseInt(req.getParameter("quizId"));
        try {
            List<Question> questions = qdao.getQuestionsForQuiz(quizId);
            int score = 0;
            for (Question q : questions) {
                String ans = req.getParameter("q_" + q.getId()); // name="q_<id>"
                if (ans != null && ans.equalsIgnoreCase(q.getCorrectOption())) {
                    score++;
                }
            }
            HttpSession s = req.getSession(false);
            User user = (User) s.getAttribute("user");
            if (user == null) {
                resp.sendRedirect(req.getContextPath() + "/user/login.jsp");
                return;
            }
            adao.saveAttempt(quizId, user.getId(), score, questions.size());
            // forward to leaderboard or result page
            resp.sendRedirect(req.getContextPath() + "/quiz/leaderboard?id=" + quizId);
        } catch (Exception e) { throw new ServletException(e); }
    }
}

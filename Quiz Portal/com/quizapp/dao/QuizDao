package com.quizapp.dao;
import com.quizapp.model.Quiz;
import com.quizapp.model.Question;
import com.quizapp.util.DBUtil;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class QuizDAO {
    public int createQuiz(Quiz q, List<Integer> questionIds) throws SQLException {
        String sql = "INSERT INTO quizzes (title,category,created_by) VALUES (?,?,?)";
        try (Connection c = DBUtil.getConnection();
             PreparedStatement ps = c.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            ps.setString(1, q.getTitle());
            ps.setString(2, q.getCategory());
            ps.setInt(3, q.getCreatedBy());
            ps.executeUpdate();
            ResultSet rs = ps.getGeneratedKeys();
            int quizId = -1;
            if (rs.next()) quizId = rs.getInt(1);

            if (quizId != -1) {
                String ins = "INSERT INTO quiz_questions (quiz_id,question_id,q_order) VALUES (?,?,?)";
                try (PreparedStatement ps2 = c.prepareStatement(ins)) {
                    int order = 1;
                    for (Integer qid: questionIds) {
                        ps2.setInt(1, quizId);
                        ps2.setInt(2, qid);
                        ps2.setInt(3, order++);
                        ps2.addBatch();
                    }
                    ps2.executeBatch();
                }
            }
            return quizId;
        }
    }

    public List<Quiz> listAll() throws SQLException {
        List<Quiz> list = new ArrayList<>();
        String sql = "SELECT * FROM quizzes";
        try (Connection c = DBUtil.getConnection();
             PreparedStatement ps = c.prepareStatement(sql);
             ResultSet rs = ps.executeQuery()) {
            while (rs.next()) {
                Quiz q = new Quiz();
                q.setId(rs.getInt("id"));
                q.setTitle(rs.getString("title"));
                q.setCategory(rs.getString("category"));
                q.setCreatedBy(rs.getInt("created_by"));
                list.add(q);
            }
        }
        return list;
    }

    public List<Question> getQuestionsForQuiz(int quizId) throws SQLException {
        String sql = "SELECT q.* FROM questions q JOIN quiz_questions qq ON q.id=qq.question_id WHERE qq.quiz_id=? ORDER BY qq.q_order";
        List<Question> list = new ArrayList<>();
        try (Connection c = DBUtil.getConnection();
             PreparedStatement ps = c.prepareStatement(sql)) {
            ps.setInt(1, quizId);
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    Question q = new Question();
                    q.setId(rs.getInt("id"));
                    q.setText(rs.getString("text"));
                    q.setOptionA(rs.getString("option_a"));
                    q.setOptionB(rs.getString("option_b"));
                    q.setOptionC(rs.getString("option_c"));
                    q.setOptionD(rs.getString("option_d"));
                    q.setCorrectOption(rs.getString("correct_option"));
                    list.add(q);
                }
            }
        }
        return list;
    }
}
